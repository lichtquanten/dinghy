generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "mongodb"
  url = env("PRISMA_DB_URL")
}

model User {
  id          String       @id @default(auto()) @map("_id") @db.ObjectId
  clerkId     String       @unique
  firstName   String
  lastName    String
  email       String       @unique

  enrollments Enrollment[]

  pairingIds  String[]     @db.ObjectId
  pairings    Pairing[]    @relation(fields: [pairingIds], references: [id])
}

model Course {
  id          String       @id @default(auto()) @map("_id") @db.ObjectId
  title       String       @unique
  joinCode    String       @unique

  enrollments Enrollment[]
  assignments Assignment[]
}

model Enrollment {
  id       String @id @default(auto()) @map("_id") @db.ObjectId
  userId   String @db.ObjectId
  user     User   @relation(fields: [userId], references: [id])
  courseId String @db.ObjectId
  course   Course @relation(fields: [courseId], references: [id])

  @@unique([userId, courseId])
}

model Assignment {
  id           String       @id @default(auto()) @map("_id") @db.ObjectId
  courseId     String       @db.ObjectId
  course       Course       @relation(fields: [courseId], references: [id])

  title        String
  description  String
  codeLanguage CodeLanguage
  starterCode  String
  dueDate      DateTime

  tasks        Task[]
  pairings     Pairing[]

  @@unique([title, courseId])
}

model Task {
  id           String     @id @default(auto()) @map("_id") @db.ObjectId
  assignmentId String     @db.ObjectId
  assignment   Assignment @relation(fields: [assignmentId], references: [id])

  order        Int
  title        String
  instructions String
  durationSecs Int
  mode         TaskMode

  testCases    TestCase[]

  @@unique([assignmentId, order])
}

enum TaskMode {
  solo
  collaborative
  review
}

model TestCase {
  id             String @id @default(auto()) @map("_id") @db.ObjectId
  taskId         String @db.ObjectId
  task           Task   @relation(fields: [taskId], references: [id])

  input          String
  expectedOutput String
  description    String
}

model Pairing {
  id               String     @id @default(auto()) @map("_id") @db.ObjectId
  assignmentId     String     @db.ObjectId
  assignment       Assignment @relation(fields: [assignmentId], references: [id])

  memberIds        String[]   @db.ObjectId
  members          User[]     @relation(fields: [memberIds], references: [id])

  isStarted        Boolean @default(false)
  isCompleted      Boolean @default(false)
  currentTaskIndex Int     @default(0)

  session          Session?
}

model Session {
  id               String         @id @default(auto()) @map("_id") @db.ObjectId
  pairingId        String         @unique @db.ObjectId
  pairing          Pairing        @relation(fields: [pairingId], references: [id])
  wherebyMeetingId String         @unique @db.ObjectId
  wherebyMeeting   WherebyMeeting @relation(fields: [wherebyMeetingId], references: [id])
}

model WherebyMeeting {
  id        String   @id @map("_id") @db.ObjectId
  session   Session?
  url       String
  expiresAt DateTime
}

enum CodeLanguage {
  javascript
  typescript
  python
  java
  cpp
  c
  rust
  go
  php
  sql
}