generator client {
  provider = "prisma-client"
  output   = "../src/generated/prisma"
}

datasource db {
  provider = "mongodb"
  url      = env("PRISMA_DB_URL")
}

enum MembershipRole {
  student
  instructor
}

enum CodeLanguage {
  javascript
  typescript
  python
  java
  cpp
  c
  rust
  go
  php
  sql
}

enum InteractionMode {
  solo
  review
  collaborative
}

model User {
  id          String             @id @default(auto()) @map("_id") @db.ObjectId
  clerkId     String             @unique
  firstName   String
  lastName    String
  email       String             @unique
  isAdmin     Boolean            @default(false)
  memberships CourseMembership[]
  pairingIds  String[]           @db.ObjectId
  pairings    Pairing[]          @relation(fields: [pairingIds], references: [id])
}

model Course {
  id          String             @id @default(auto()) @map("_id") @db.ObjectId
  title       String             @unique
  joinCode    String             @unique
  memberships CourseMembership[]
  assignments Assignment[]
}

model CourseMembership {
  id       String         @id @default(auto()) @map("_id") @db.ObjectId
  userId   String         @db.ObjectId
  user     User           @relation(fields: [userId], references: [id])
  courseId String         @db.ObjectId
  course   Course         @relation(fields: [courseId], references: [id])
  role     MembershipRole @default(student)

  @@unique([userId, courseId])
}

model Assignment {
  id           String       @id @default(auto()) @map("_id") @db.ObjectId
  courseId     String       @db.ObjectId
  course       Course       @relation(fields: [courseId], references: [id])
  title        String
  description  String
  codeLanguage CodeLanguage
  starterCode  String
  dueDate      DateTime
  timeLimitSecs Int?
  tasks        Task[]
  pairings     Pairing[]

  @@unique([title, courseId])
}

model Task {
  id           String     @id @default(auto()) @map("_id") @db.ObjectId
  assignmentId String     @db.ObjectId
  assignment   Assignment @relation(fields: [assignmentId], references: [id])
  order        Int
  title        String
  instructions String
  phases       Phase[]
  testCases    TestCase[]

  @@unique([assignmentId, order])
}

model Phase {
  id              String          @id @default(auto()) @map("_id") @db.ObjectId
  taskId          String          @db.ObjectId
  task            Task            @relation(fields: [taskId], references: [id])
  order           Int
  interactionMode InteractionMode
  minTimeSecs     Int?
  maxTimeSecs     Int?

  @@unique([taskId, order])
}

model TestCase {
  id             String @id @default(auto()) @map("_id") @db.ObjectId
  taskId         String @db.ObjectId
  task           Task   @relation(fields: [taskId], references: [id])
  input          String
  expectedOutput String
  description    String
}

model Pairing {
  id               String          @id @default(auto()) @map("_id") @db.ObjectId
  assignmentId     String          @db.ObjectId
  assignment       Assignment      @relation(fields: [assignmentId], references: [id])
  partnerIds       String[]        @db.ObjectId
  partners         User[]          @relation(fields: [partnerIds], references: [id])
  isYjsInitialized Boolean         @default(false)
  startedAt        DateTime?
  isCompleted      Boolean         @default(false)
  session          Session?
}

model Session {
  id               String         @id @default(auto()) @map("_id") @db.ObjectId
  pairingId        String         @unique @db.ObjectId
  pairing          Pairing        @relation(fields: [pairingId], references: [id])
  wherebyMeetingId String         @unique @db.ObjectId
  wherebyMeeting   WherebyMeeting @relation(fields: [wherebyMeetingId], references: [id])
}

model WherebyMeeting {
  id        String   @id @default(auto()) @map("_id") @db.ObjectId
  wherebyId String   @unique
  session   Session?
  url       String
  expiresAt DateTime
}